<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dino惡搞版 By hongjan</title>
    <!-- 添加網站圖標 -->
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* 讓標題和按鈕垂直排列 */
            height: 100vh;
            background-color: #2a8fd3;
            position: relative; /* 設定父容器 */
        }

        canvas {
            border: 5px solid #000000;
            position: relative; /* 設定 canvas 為相對定位 */
            width: 100%;
            max-width: 600px; /* 設定最大寬度為 600px，以防止內容在大螢幕上過寬 */
        }

        .button {
            background-color: #ff7300; /* 橘色 */
            border: none;
            color: rgb(233, 233, 233);
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
        }

        .button:hover {
            background-color: #a14e00; /* 深橘色 */
        }

        .text-background {
            width: 100%;
            height: 50px; /* 調整高度以適應文字 */
            background-color: #2a8fd3; /* 背景色與 body 相同 */
            position: absolute; /* 絕對定位 */
            bottom: 0; /* 與底部對齊 */
        }

        /* 手機和平板設備樣式 */
        @media only screen and (max-width: 768px) {
            body {
                transform: scale(0.8); /* 縮小整個畫面 */
                transform-origin: top center; /* 設定縮放原點為畫面頂部中心 */
            }
        }
        /* 右上角靜音按鈕樣式 */
        #muteButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        #muteButton:hover {
            color: yellow;
        }
    </style>
</head>
<body>
    <!-- 添加背景音樂 -->
    <audio id="bgMusic" loop autoplay>
        <source src="music.mp3" type="audio/mpeg">
        無法撥放音訊，瀏覽器不支援HTML5
    </audio>

    <!-- 右上角靜音按鈕 -->
    <button id="muteButton" onclick="toggleMute()">
        🔊 <!-- 撥音符號 -->
    </button>

    <h1>Dino惡搞版</h1>
    <p>點擊或按下空白鍵使老師跳躍，避開障礙物，盡可能獲得更高的怒氣值！</p>
    <p>作者：hongjan</p>
    <button id="startButton" class="button">開始遊戲</button>
    <canvas id="gameCanvas" width="600" height="200" style="display: none;"></canvas>
    <button id="restartButton" class="button" style="display: none;">重新開始</button>
    <a href="https://github.com/hongjan371792/Dino" class="button" target="_blank">GitHub</a>
    <a id="githubLink" class="button" target="_blank">Gihub API載入錯誤</a> <!-- GitHub 按钮 -->
    <div class="text-background"></div>

    <script>
        if (window.addEventListener) {
            window.addEventListener("DOMNodeRemoved", function () { window.location.reload(); }, true);
            window.addEventListener("DOMNodeRemovedFromDocument", function () { window.location.reload(); }, true);
        } 
        //禁用右键（防止右键查看源代码） 
        window.oncontextmenu = function () { return false; }
        //禁止任何键盘敲击事件（防止F12和shift+ctrl+i调起开发者工具） 
        window.onkeydown = window.onkeyup = window.onkeypress = function () {
            window.event.returnValue = false;
            return false;
        }        
        // JavaScript 代码部分

        // 获取 GitHub 项目的最新版本信息
        function getLatestVersion() {
            // 发起 HTTP 请求获取 GitHub 项目的信息
            fetch('https://api.github.com/repos/hongjan371792/Dino/releases/latest')
                .then(response => response.json())
                .then(data => {
                    // 提取最新版本号
                    const latestVersion = data.tag_name;
                    // 构建 GitHub 按钮链接
                    const githubButton = document.getElementById('githubLink');
                    githubButton.href = `https://github.com/hongjan371792/Dino/releases/tag/${latestVersion}`;
                    githubButton.innerText = `更新說明 版本：${latestVersion}`; // 更新按钮文本显示最新版本号
                })
                .catch(error => console.error('Error:', error));
        }

        // 页面加载时调用函数以获取最新版本信息并更新 GitHub 按钮链接
        window.onload = function() {
            getLatestVersion();
        };
        const bgMusic = document.getElementById('bgMusic');
        bgMusic.volume = 0.5; // 設置音量為50%
        let isMuted = false; // 新增一個變數來追蹤音樂的靜音狀態

        // 檢測設備類型
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 如果是手機或平板，應用手機樣式
        if (isMobile) {
            document.body.classList.add('mobile');
        }

        // 新增 toggleMute 函數來切換靜音狀態
        function toggleMute() {
            if (isMuted) {
                bgMusic.play();
                isMuted = false;
                document.getElementById('muteButton').innerHTML = '🔊'; 
            } else {
                bgMusic.pause();
                isMuted = true;
                document.getElementById('muteButton').innerHTML = '🔇'; 
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const dinoImg = new Image();
        dinoImg.src = 'dino.png'; // 角色圖片路徑

        const obstacleImg1 = new Image();
        obstacleImg1.src = 'obstacle1.png'; // 第一種障礙物圖片路徑

        const obstacleImg2 = new Image();
        obstacleImg2.src = 'obstacle2.png'; // 第二種障礙物圖片路徑

        const cloudImg = new Image();
        cloudImg.src = 'cloud.png'; // 雲朵圖片路徑

        let score = 0;
        let highScore = getCookie('highScore') || 0; // 獲取 cookie 中的最高分數，如果不存在則預設為0
        let gameOver = false;
        let gameStarted = false;

        const dino = {
            x: 50,
            y: 150,
            width: 50,
            height: 50,
            speed: 5,
            jumpForce: 20, // 調整角色跳躍的力量
            fallingSpeed: 5, // 調整角色下落的速度
            jumping: false,
            draw() {
                ctx.drawImage(dinoImg, this.x, this.y, this.width, this.height);
            }
        };

        let obstacle = null;

        class Obstacle {
            constructor() {
                this.width = 20; // 障礙物寬度
                this.height = Math.random() > 0.5 ? 20 : 40; // 隨機選擇兩種不同高度的障礙物
                if (Math.random() > 0.5) {
                    this.img = obstacleImg1;
                } else {
                    this.img = obstacleImg2;
                }
                this.x = canvas.width;
                this.y = canvas.height - this.height;
            }

            draw() {
                ctx.drawImage(this.img, this.x, this.y, this.width, this.height); // 繪製障礙物圖片
            }

            update() {
                this.x -= dino.speed;
            }
        }

        class Cloud {
            constructor() {
                this.width = Math.random() * 100 + 50; // 雲朵寬度
                this.height = this.width * 0.6; // 根據比例計算高度
                this.x = canvas.width;
                this.y = Math.random() * 100; // 隨機垂直位置
                this.speed = Math.random() * 0.5 + 0.1; // 隨機速度
            }

            draw() {
                ctx.drawImage(cloudImg, this.x, this.y, this.width, this.height); // 繪製雲朵圖片
            }

            update() {
                this.x -= this.speed;
                if (this.x + this.width < 0) {
                    this.x = canvas.width; // 雲朵飄過畫面後重置位置
                }
                this.width += Math.sin(Date.now() / 1000) * 0.5; // 放大縮小效果
                this.height += Math.cos(Date.now() / 1000) * 0.5; // 放大縮小效果
            }
        }

        let clouds = []; // 存儲雲朵

        function jump() {
            if (!dino.jumping) { // 只有在不在跳躍狀態時才能跳躍
                dino.jumping = true;
                let jumpInterval = setInterval(() => {
                    dino.y -= dino.jumpForce;
                    if (dino.y <= 30) { // 角色最高點為30
                        clearInterval(jumpInterval);
                        let fallInterval = setInterval(() => {
                            dino.y += dino.fallingSpeed;
                            if (dino.y >= 150) { // 角色回到地面
                                clearInterval(fallInterval);
                                dino.jumping = false;
                            }
                        }, 20);
                    }
                }, 20);
            }
        }

        document.addEventListener('keydown', event => {
            if (event.code === 'Space') {
                jump();
            }
        });

        document.addEventListener('touchstart', jump); // 觸控事件

        document.getElementById('startButton').addEventListener('click', () => {
            gameStarted = true;
            document.getElementById('startButton').style.display = 'none';
            canvas.style.display = 'block';
            bgMusic.play(); // 在按鈕點擊後播放音樂
            gameLoop();
        });

        document.getElementById('restartButton').addEventListener('click', () => {
            score = 0;
            gameOver = false;
            obstacle = null;
            document.getElementById('restartButton').style.display = 'none';
            gameLoop();
        });

        function generateObstacle() {
            if (!obstacle) {
                obstacle = new Obstacle();
            }
        }

        function checkCollisions() {
            if (obstacle && dino.x < obstacle.x + obstacle.width &&
                dino.x + dino.width > obstacle.x &&
                dino.y < obstacle.y + obstacle.height &&
                dino.y + dino.height > obstacle.y) { // 確認碰撞
                    gameOver = true;
                    updateHighScore(); // 更新最高分數
                    return;
                }
            score++;
        }

        function updateHighScore() {
            if (score > highScore) {
                highScore = score;
                setCookie('highScore', highScore, 365); // 將最高分數儲存到 cookie 中，有效期為 365 天
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';')[0];
        }

        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function gameLoop() {
            if (!gameOver) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 更新並繪製雲朵 (雲的優先及提升以將圖層設在最下方)
                clouds.forEach(cloud => {
                    cloud.update();
                    cloud.draw();
                });

                dino.draw();

                if (!obstacle || obstacle.x + obstacle.width < 0) {
                    obstacle = new Obstacle();
                }

                if (obstacle) {
                    obstacle.draw();
                    obstacle.update();
                }

                checkCollisions();

                ctx.fillStyle = '#333';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center'; // 設定文字置中
                ctx.fillText(`怒氣值: ${score}`, canvas.width / 2, 30); // 繪製分數文字
                ctx.fillText(`最高: ${highScore}`, canvas.width / 2, 60); // 繪製最高分文字

                requestAnimationFrame(gameLoop);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#333';
                ctx.font = '30px Arial';
                ctx.textAlign = 'center'; // 設定文字置中
                ctx.fillText('你用了免死金牌，被罵得更慘了', canvas.width / 2, canvas.height / 2 - 20);
                ctx.fillText(`怒氣值: ${score}`, canvas.width / 2, canvas.height / 2 + 20);
                ctx.fillText(`最高: ${highScore}`, canvas.width / 2, canvas.height / 2 + 60);
                document.getElementById('restartButton').style.display = 'block';
            }
        }

        // 生成雲朵
        function generateClouds() {
            for (let i = 0; i < 3; i++) { // 生成 3 個雲朵
                const cloud = new Cloud();
                clouds.push(cloud);
            }
        }

        generateClouds(); // 遊戲開始時生成雲朵
    </script>
</body>
</html>
